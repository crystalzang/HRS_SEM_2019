---
title: "rand"
author: "CZ"
date: "3/25/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(readr)
library(haven)
library(data.table)
library(ggplot2)
library(mosaic)
library(skimr)
#functions
'%ni%' <- Negate('%in%')
```


```{r}
#rand <- read_csv("~/Desktop/data/randhrs.csv")
```


Wave 12, which is from 2014. 

# Step 1: Rand data from Wave 12, which is 2014. n = 4372 
`nrow(rand_2014)`
```{r}
#Cohort
table(rand$HACOHORT) 
#Wave 14
table(rand$R12PENINC)
table(rand$R12PENINC,rand$HACOHORT)

rand_2014<-rand%>%
  filter(R12PENINC == "1.Yes")

#write.csv(rand_2014, file="data/rand_2014.csv", row.names = F)
nrow(rand_2014)
```


```{r}
rand_2014   <- read_csv("~/Desktop/data/rand/rand_2014.csv")

id <- rand_2014 %>%
  select(HHIDPN, HHID, PN, 
         HACOHORT,  #cohort
          R12CESD, S12CESD, #CESD Score, binary level yes or no
         
          R12ADLA, S12ADLA, #ADL Summary: sum ADLs where Respondent reports any difficulty
          R12OOPMD, S12OOPMD,  #Total expenditure
         RAGENDER  #gender
        )

#skim(id)
#rename
setnames(id ,
         old=c("R12ADLA", "S12ADLA", "R12CESD", "S12CESD", "R12OOPMD", "S12OOPMD", "RAGENDER"),
         new = c("R_ADL", "S_ADL", "R_CESD", "S_CESD", "R_expense", "S_expense", "sex"))
```


# Step 2: Missing variables n = 2025.
From step 1 (n=`nrow(rand_2014)` =4372), 

We excluded `1-nrow(rand_2014_R_valid)/nrow(rand_2014)` 6.13% data for missing variables for respondents.

We excluded `1-nrow(rand_2014_R_valid)/nrow(rand_2014)` 51.01% data for missing variables for spouses.

We excluded `1-nrow(rand_2014_valid)/nrow(rand_2014))` 53.68% data for missing variables for both respondents and spouses, which left us 2025 observations.
```{r}
table(rand_2014$S12AGEY_E)
table(rand_2014$R12ADLA,useNA = "a")
table(rand_2014$S12ADLA, useNA = "a")

table(rand_2014$R12CESD, useNA="a")
table(rand_2014$S12CESD, useNA="a")

favstats(rand_2014$R12OOPMD)
favstats(rand_2014$S12OOPMD)


rand_2014_R_valid <- id%>%
  filter(!is.na(R_ADL), !is.na(R_CESD), !is.na(R_expense))
1-nrow(rand_2014_R_valid)/nrow(rand_2014)

rand_2014_S_valid <- id%>%
  filter(!is.na(S_ADL), !is.na(S_CESD), !is.na(S_expense))
1-nrow(rand_2014_S_valid)/nrow(rand_2014)

rand_2014_valid <- id%>%
  filter(!is.na(R_ADL), !is.na(R_CESD), !is.na(R_expense),!is.na(S_ADL), !is.na(S_CESD), !is.na(S_expense))
1-nrow(rand_2014_valid)/nrow(rand_2014)

```




```{r}
#There shouldn't be any missing R_ADL
tally(rand_2014$S_ADL)

#Missing S_ADL meaning that those helper don't have ADL
tally(rand_2014$S_ADL)

#There shouldn't be any missing R_CESD, we want all informaiton
tally(rand_2014$R_CESD)

#There shouldn't be any missing S_CESD, we want all informaiton
tally(rand_2014$S_CESD)
```

#Couple Investigation
```{r}
#check couple
id_group<-rand_2014_R_valid%>%
  group_by(HHID)%>%
  summarize(N=n())

#Only 2 is reasonable
tally(id_group$N)

#Valid dyad HHID 
#id_valid_dyad_id <- id_group%>%
#  filter(N==2)%>%
#  select(HHID)%>%
#  mutate(dyad = "Y")

#Cleaned dyad data
#id_valid_dyad <- left_join(id_valid, id_valid_dyad_id, by="HHID")%>%
#  filter(dyad == "Y")

#write.csv(id_valid_dyad, file="rand_dyad.csv", row.names = F)
#id_valid_dyad   <-read_csv("rand_dyad.csv") 

```


# Helper READ IN
About `1-nrow(helper) /nrow(H14G_HP)` = 50.5% helpers were spouse.  We excluded 49.5% of data.
```{r}
#year: 2014
H14G_HP <- read_sav("/Users/crystalzang/Desktop/data/helper/H14G_HP.sav", encoding = NULL, user_na = FALSE)%>%
  filter(!is.na(OPN_SP))%>%
  filter(OPN_SP %ni% c("","811", "812", "821", "831", "832", "841", "822"))%>%
  mutate(respondent_id= paste(HHID, PN, sep=""), spouse_id=paste(HHID, OPN_SP, sep=""))

helper <- H14G_HP%>%
  filter(OG069 == "2")

1-nrow(helper) /nrow(H14G_HP)

#convert NA value in month/wk/day to 0 
helper<- helper %>%
  mutate(OG070 = coalesce(OG070,0),
         OG071 = coalesce(OG071,0),
         OG072 = coalesce(OG072,0),
         OG073 = coalesce(OG073,0))

#filter out useless values in month/wk/day/hr
helper <- helper %>%
  filter(OG070 %in% 0:31,
         OG071 %in% 0:7,
         OG072 %in% 0:1,
         OG073 %in% 1:24)

#calculate helping hours (assume that one month has 4 weeks and 30 days)
helper <-helper%>%
  mutate(helper_time= OG070*OG073+OG071*4*OG073+OG072*30*OG073)

helper_id <- helper%>%
  select(respondent_id, spouse_id, helper_time) %>% 
  mutate(helper="Y")
```


```{r eval=FALSE, include=FALSE}
#plot helper hours
ggplot(data=helper_2014, aes(x=helper_time))+geom_histogram()
count(helper_2014$helper_time==1)

table(helper$OG073)

test <- helper%>%
  group_by(OG070, OG073)%>%
  summarize(N=n())
```


# Create sub-dataset by helper status
```{r}
#Join helper with spouse in RAND, indicating spouses who are helpers
class(rand_2014_R_valid$HHIDPN)
class(helper_id$respondent_id)
rand_2014_R_valid $HHIDPN<-as.character(rand_2014_R_valid $HHIDPN)

helper <- left_join(rand_2014_R_valid, helper_id, by= c("HHIDPN"= "respondent_id"))%>%
  filter(helper=="Y")%>%
  mutate(helper_status = "helper")

```

# Type 1 Both helper
```{r}
#check couple
dyad_helper_both<-helper%>%
  group_by(HHID)%>%
  mutate(N=n())%>%
  filter(N==2)
```



# Type 2 Women helper
```{r}
table(helper$sex)

helper_f <- helper %>%
  filter(sex=="2.Female")

helper_f_id<-helper_f%>%
  select(spouse_id)%>%
  as.data.frame()

helper_f_spouse <- left_join(helper_f_id, id_valid_dyad , by= c("spouse_id" = "HHIDPN"))%>%
  mutate(helper_status = "not helper", helper_time = 0)

names(helper_f_spouse)[1]<- "HHIDPN"
helper_f<- helper_f%>%
  select(-spouse_id, -helper)

dyad_helper_f <- rbind(helper_f, helper_f_spouse)

write.csv(dyad_helper_f, file="dyad_helper_f.csv", row.names = F)

```


```{r}
helper_m <- helper %>%
  filter(sex=="1.Male")

helper_m_id<-helper_m%>%
  select(spouse_id)%>%
  as.data.frame()

helper_m_spouse <- left_join(helper_m_id, id_valid_dyad , by= c("spouse_id" = "HHIDPN"))%>%
  mutate(helper_status = "not helper", helper_time = 0)

names(helper_m_spouse)[1]<- "HHIDPN"
helper_m<- helper_m%>%
  select(-spouse_id, -helper)

dyad_helper_m <- rbind(helper_m, helper_m_spouse)
write.csv(dyad_helper_m, file="dyad_helper_m.csv", row.names = F)

```



